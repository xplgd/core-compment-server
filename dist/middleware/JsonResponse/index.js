"use strict";var __awaiter=this&&this.__awaiter||function(t,e,s,r){return new(s||(s=Promise))(function(n,o){function a(t){try{u(r.next(t))}catch(t){o(t)}}function i(t){try{u(r.throw(t))}catch(t){o(t)}}function u(t){t.done?n(t.value):new s(function(e){e(t.value)}).then(a,i)}u((r=r.apply(t,e||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const isJSON=require("koa-is-json"),stringify=require("streaming-json-stringify"),util=require("../../util"),logger_1=require("../logger"),initJsonResp=t=>{const e=logger_1.getLogger("error",t.home,t.logPath);return(t,s)=>__awaiter(this,void 0,void 0,function*(){let r=0,n=null;const o=Object.hasOwnProperty.call(t.query,"pretty"),a=Object.hasOwnProperty.call(t.query,"suppress_response_code");try{t.state.start=new Date,yield s(),404!==t.response.status||t.response.body||t.throw(404);const i=(n=t.body)&&"function"==typeof n.pipe&&n._readableState&&n._readableState.objectMode;if(!isJSON(n)&&!i)return;if(i){const e=stringify();return o&&(e.space=2),void(t.body=n.pipe(e))}jsonFormatter(t,r,n,o,2,a)}catch(s){if(t.status="number"==typeof s.status?s.status:500,t.app.emit("error",s,t),r=t.status,n={name:s.name,message:s.message,code:s.code},404!==s.status&&null!=e)try{const n=[];n.push(`[${util.requestIp(t)}]`),n.push(`[${t.method}]`),n.push(`[${t.url}]`),n.push(`[${r}]`),n.push(`${t.request.header["user-agent"]}\n${s.message}\n${s.stack}\n`),e.error(n.join(" "))}catch(t){console.log(t)}t.status=200,jsonFormatter(t,r,n,o,2,a)}})};exports.initJsonResp=initJsonResp;const jsonFormatter=(t,e,s,r,n,o=!1)=>{t.type="application/json",t.state.end=new Date;const a=o?s:{};o||(a.code=e,a.data=s,"production"!==process.env.NODE_ENV&&(a.__dev=!0,a.__ts={s:t.state.start.toUTCString(),e:t.state.end.toUTCString(),ts:t.state.end-t.state.start})),t.body=r?JSON.stringify(a,null,n):JSON.stringify(a)};