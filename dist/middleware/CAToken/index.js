"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))(function(r,o){function c(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){e.done?r(e.value):new i(function(t){t(e.value)}).then(c,a)}u((n=n.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0});const util=require("../../util"),crypto=require("../../util/crypto"),Exception_1=require("../../exception/Exception"),ca_1=require("../../exception/ca"),SCScope=require("./SCScope"),CAToken=e=>{const t=e.ignorePattens||[];return function(i,n){return __awaiter(this,void 0,void 0,function*(){try{const r=i.originalUrl;if(t.findIndex(e=>r.startsWith(e))<0){const t=i.headers[e.header];if(null==t)throw new Exception_1.default(ca_1.default.TOKEN_NEEDED);const n=new RegExp(`^${e.prefix}\\s+(.*?)$`,"ig").exec(t);if(null===n)throw new Exception_1.default(ca_1.default.INVALID_TOKEN);const r=verifyConsoleUserIdentity(n[1],e.scope,e.publicKey,e.keySize);void 0!==e.verify&&(yield e.verify(r)),i.state.user=r}yield n()}catch(e){throw e}})}};exports.CAToken=CAToken;const verifyConsoleUserIdentity=(e,t,i,n)=>{if(util.validator.stringIsNullOrEmpty(e)||util.validator.stringIsNullOrEmpty(e))throw new Exception_1.default(ca_1.default.INVALID_TOKEN_FORMAT);let r;try{r=decryptToken(e,i,n)}catch(e){throw new Exception_1.default(ca_1.default.RESOVE_TOKEN_FAILED)}if(Date.now()-Math.floor(1e3*r.create_on)>1e3*r.expire_in)throw new Exception_1.default(ca_1.default.TOKEN_HAS_EXPIRED);if(0!==(t=t||"").length&&SCScope.SC_SCOPE_FULL_PERMITTED!==r.scope&&void 0===r.scope.split(/,/gi).find(e=>e===t))throw new Exception_1.default(ca_1.default.SCOPE_NOT_PERMITTED);return r},decryptToken=(e,t,i)=>(e=util.formatter.fromWebSafeBase64(e),JSON.parse(crypto.rsa.publicDecrypt(e,t,i)));